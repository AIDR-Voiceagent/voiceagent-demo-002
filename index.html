<!doctype html> 
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Voice Demo</title>

  <style>
    :root{
      --bg:#000;
      --card:#0f0f10;
      --muted:#bdbdbd;
      --accent:#00ff9d;
      --glow:rgba(255,255,255,0.25);
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
      color:#fff;
    }
    .page-wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .card{
      width:78%;
      max-width:920px;
      background:linear-gradient(180deg,#121212 0,#0f0f10 100%);
      border-radius:18px;
      padding:36px;
      box-shadow:0 0 45px var(--glow);
      text-align:center;
    }
    h1{margin-bottom:18px;font-size:28px;}
    .controls{
      display:flex;
      gap:18px;
      justify-content:center;
      margin-bottom:12px;
    }
    .btn{
      padding:11px 28px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      color:#fff;
      font-size:15px;
      background:#1b1b1b;
      border:1px solid #333;
    }
    .btn:disabled{opacity:.4;cursor:not-allowed;}
    .status{color:var(--muted);margin:6px 0 18px;font-weight:600;}
    .mic-bubble{
      width:86px;height:86px;border-radius:50%;
      margin:14px auto;display:flex;
      align-items:center;justify-content:center;
      border:2px solid rgba(255,255,255,0.12);
    }
    .mic-bubble.active{box-shadow:0 0 35px rgba(255,255,255,0.45);}
    .volume-bar{
      width:60%;height:8px;margin:10px auto;
      background:#222;border-radius:6px;overflow:hidden;
    }
    .volume-fill{height:100%;width:0%;background:#fff;}
    .transcript-box{
      width:86%;height:180px;background:#151515;
      border-radius:10px;margin:14px auto 0;
      padding:14px;overflow-y:auto;font-size:14px;
      text-align:left;
    }
    .msg-user{color:var(--accent);margin-bottom:6px;font-weight:600}
    .msg-agent{margin-bottom:6px;opacity:.95}
  </style>
</head>

<body>
<div class="page-wrap">
  <div class="card">
    <h1>AI Voice Demo</h1>

    <div class="controls">
      <button id="connectBtn" class="btn" disabled>Verbinden</button>
      <button id="stopBtn" class="btn">Stop</button>
    </div>

    <div id="statusText" class="status">SDK wird geladen…</div>
    <div id="micBubble" class="mic-bubble">MIC</div>

    <div class="volume-bar"><div id="volFill" class="volume-fill"></div></div>
    <div id="transcriptBox" class="transcript-box"></div>
  </div>
</div>

<!-- ✅ VAPI SDK – FIXED SOURCE -->
<script src="https://cdn.jsdelivr.net/npm/@vapi-ai/web/dist/index.umd.js"></script>

<script>
const PUBLIC_KEY = "3857a4fd-9664-470b-b523-759ca2db2753";
const ASSISTANT_ID = "9939aaaf-23ff-490a-8daf-665758ff117b";

const connectBtn = document.getElementById("connectBtn");
const statusText = document.getElementById("statusText");
const transcriptBox = document.getElementById("transcriptBox");
const micBubble = document.getElementById("micBubble");
const volFill = document.getElementById("volFill");

let vapi, call, audioCtx, analyser, raf;

// SDK WAIT
const sdkTimer = setInterval(() => {
  if (window.Vapi && window.Vapi.default) {
    clearInterval(sdkTimer);
    connectBtn.disabled = false;
    statusText.textContent = "Bereit.";
  }
}, 100);

function addMsg(t,c){
  const d=document.createElement("div");
  d.className=c; d.textContent=t;
  transcriptBox.appendChild(d);
  transcriptBox.scrollTop=transcriptBox.scrollHeight;
}

async function startVisualizer(stream){
  audioCtx=new AudioContext();
  const src=audioCtx.createMediaStreamSource(stream);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  const data=new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);
  const loop=()=>{
    analyser.getByteTimeDomainData(data);
    let s=0;
    for(let i=0;i<data.length;i++){const v=data[i]-128;s+=v*v;}
    const vol=Math.min(1,Math.sqrt(s/data.length)/50);
    volFill.style.width=(vol*100)+"%";
    micBubble.classList.toggle("active",vol>0.15);
    raf=requestAnimationFrame(loop);
  }; loop();
}

connectBtn.onclick = async ()=>{
  try{
    statusText.textContent="Verbinden…";
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    await startVisualizer(stream);

    vapi = new window.Vapi.default(PUBLIC_KEY);
    call = await vapi.start({
      assistantId: ASSISTANT_ID,
      audio:{ input:stream, output:true }
    });

    statusText.textContent="Verbunden";

    call.on("transcript", e=>{
      if(e?.text){
        addMsg((e.role==="user"?"Du: ":"Agent: ")+e.text,
          e.role==="user"?"msg-user":"msg-agent");
      }
    });

    call.on("close", ()=>statusText.textContent="Getrennt");
  }catch(e){
    console.error(e);
    statusText.textContent="Verbindung fehlgeschlagen";
  }
};

document.getElementById("stopBtn").onclick=()=>{
  call?.stop(); audioCtx?.close();
  cancelAnimationFrame(raf);
  volFill.style.width="0%";
  micBubble.classList.remove("active");
  statusText.textContent="Getrennt";
};
</script>
</body>
</html>
