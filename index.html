<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Voice Demo</title>
  <style>
    :root{
      --bg:#000;--card:#0f0f10;--card-inner:#151515;--muted:#bdbdbd;
      --accent:#00ff9d;--glow:rgba(255,255,255,0.24);
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#fff;}
    .page-wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;}
    .card{width:78%;max-width:920px;background:linear-gradient(180deg,#121212 0,#0f0f10 100%);
      border-radius:18px;padding:36px;box-shadow:0 12px 50px rgba(0,0,0,.7),0 0 40px var(--glow);
      border:1px solid rgba(255,255,255,.03);text-align:center}
    h1{margin:0 0 18px;font-size:28px}
    .controls{display:flex;gap:18px;justify-content:center;margin-bottom:12px}
    .btn{padding:11px 28px;border-radius:10px;border:1px solid rgba(255,255,255,.06);
      cursor:pointer;font-weight:600;color:#fff;font-size:15px;background:rgba(255,255,255,.03)}
    .status{color:var(--muted);margin:6px 0 18px;font-weight:600;min-height:20px}
    .mic-bubble{width:86px;height:86px;border-radius:50%;margin:14px auto 8px;display:flex;
      align-items:center;justify-content:center;background:linear-gradient(180deg,#0b0b0b,#0f0f10);
      border:2px solid rgba(255,255,255,.06);font-weight:700}
    .mic-bubble.active{box-shadow:0 0 18px rgba(0,255,157,.25);border-color:var(--accent)}
    .volume-wrap{width:60%;margin:8px auto 6px}
    .volume-bar{width:100%;height:8px;background:#171717;border-radius:8px;overflow:hidden}
    .volume-fill{width:0%;height:100%;background:#fff;transition:width .05s linear}
    .volume-label{margin-top:8px;font-size:14px}
    .transcript-title{margin-top:22px;font-size:18px}
    .transcript-box{width:86%;max-width:760px;height:180px;background:linear-gradient(180deg,#111,#151515);
      border-radius:10px;margin:12px auto 0;padding:14px 16px;overflow-y:auto;border:1px solid rgba(255,255,255,.03);
      box-shadow:0 8px 26px rgba(0,0,0,.6);font-size:14px;line-height:1.45;text-align:left}
    .msg-user{color:var(--accent);margin-bottom:8px;font-weight:600}
    .msg-agent{margin-bottom:8px;opacity:.95}
    @media(max-width:700px){.card{padding:20px;width:94%}.volume-wrap{width:80%}
      .transcript-box{width:94%;height:150px}.mic-bubble{width:70px;height:70px}}
  </style>
</head>
<body>
<div class="page-wrap"><div class="card">
  <h1>AI Voice Demo</h1>
  <div class="controls">
    <button id="connectBtn" class="btn">Verbinden</button>
    <button id="stopBtn" class="btn">Stop</button>
  </div>
  <div id="statusText" class="status">Bereit.</div>
  <div id="micBubble" class="mic-bubble">MIC</div>
  <div class="volume-wrap"><div class="volume-bar"><div id="volFill" class="volume-fill"></div></div>
    <div class="volume-label">Lautstärke</div></div>
  <div class="transcript-title">Transkript</div>
  <div id="transcriptBox" class="transcript-box"></div>
</div></div>

<script type="module">
// ===== KONFIGURATION (NUR DAS FÜR KUNDEN ÄNDERN) =====
const PUBLIC_KEY = "3857a4fd-9664-470b-b523-759ca2db2753";
const ASSISTANT_ID = "9939aaaf-23ff-490a-8daf-665758ff117b";
// ====================================================

const statusText = document.getElementById('statusText');
const micBubble = document.getElementById('micBubble');
const volFill = document.getElementById('volFill');
const transcriptBox = document.getElementById('transcriptBox');
let vapi, call, stream, ctx, analyser, raf;

function addMsg(t,c){const d=document.createElement('div');d.className=c;d.textContent=t;
  transcriptBox.appendChild(d);transcriptBox.scrollTop=1e9}

async function loadSdk(){
  const m = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web/dist/index.js');
  return m.default || m.Vapi;
}

async function visual(s){ctx=new AudioContext();const src=ctx.createMediaStreamSource(s);
  analyser=ctx.createAnalyser();analyser.fftSize=256;src.connect(analyser);
  const d=new Uint8Array(analyser.frequencyBinCount);
  (function f(){analyser.getByteTimeDomainData(d);let sum=0;
    for(let i=0;i<d.length;i++){const v=d[i]-128;sum+=v*v}
    const v=Math.min(1,Math.sqrt(sum/d.length)/50);
    volFill.style.width=(v*100)+'%';micBubble.classList.toggle('active',v>.22);
    raf=requestAnimationFrame(f)})();}

async function stopAll(){if(raf)cancelAnimationFrame(raf);volFill.style.width='0%';
  micBubble.classList.remove('active');if(ctx)await ctx.close();ctx=null;
  if(stream)stream.getTracks().forEach(t=>t.stop());stream=null}

connectBtn.onclick = async ()=>{
  statusText.textContent='Verbinden…';
  try{
    const Vapi = await loadSdk();
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
    await visual(stream);
    vapi = new Vapi(PUBLIC_KEY);
    call = await vapi.start({assistantId:ASSISTANT_ID,audio:{input:stream,output:true}});
    statusText.textContent='Verbunden';
    call.on('transcript',e=>e?.text&&addMsg((e.role==='user'?'Du: ':'Agent: ')+e.text,e.role==='user'?'msg-user':'msg-agent'));
    call.on('close',()=>{statusText.textContent='Getrennt';stopAll()});
    call.on('error',()=>{statusText.textContent='Verbindung beendet';stopAll()});
  }catch(e){console.error(e);statusText.textContent='Verbindung fehlgeschlagen';await stopAll()}
};

stopBtn.onclick = async ()=>{
  try{call?.stop?.();call?.disconnect?.();vapi?.stop?.()}catch(e){}
  await stopAll();statusText.textContent='Getrennt';
};
</script>
</body>
</html>
